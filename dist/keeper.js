"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Keeper = void 0;
// import {Redis} from "ioredis"
const R = require("ramda");
const nilOrEmpty = (obj) => R.anyPass([R.isNil, R.isEmpty])(obj);
const Keeper = (dat, getCache, keygen, fn) => async (...args) => {
    const cache = getCache(dat.uri);
    const cacheKey = keygen(args);
    const cacheResult = await cache.get(cacheKey);
    const expireTime = dat.options.expire;
    const ignoreCache = dat.options.ignoreCache;
    if (ignoreCache || nilOrEmpty(cacheResult)) {
        return await onCacheMiss({ cache, cacheKey, fn, expireTime }, ...args);
    }
    if (dat.options.parseJSON) {
        return JSON.parse(cacheResult);
    }
    return cacheResult;
};
exports.Keeper = Keeper;
const onCacheMiss = async ({ cache, cacheKey, fn, expireTime }, ...args) => {
    const result = await fn.apply(fn, args);
    // cache if result is neither nil nor empty
    if (!nilOrEmpty(result)) {
        expireTime ?
            cache.setex(cacheKey, expireTime, JSON.stringify(result)) :
            cache.set(cacheKey, JSON.stringify(result));
    }
    return result;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2VlcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2tlZXBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxnQ0FBZ0M7QUFDaEMsMkJBQTBCO0FBRTFCLE1BQU0sVUFBVSxHQUFHLENBQ2pCLEdBQVEsRUFDZ0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBRTFFLE1BQU0sTUFBTSxHQUFHLENBQ3BCLEdBR0MsRUFDRCxRQUEwQyxFQUMxQyxNQUFrQyxFQUNsQyxFQUFrQyxFQUNBLEVBQUUsQ0FDcEMsS0FBSyxFQUFFLEdBQUcsSUFBSSxFQUFFLEVBQUU7SUFDaEIsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUMvQixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDN0IsTUFBTSxXQUFXLEdBQUcsTUFBTSxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQzdDLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFBO0lBQ3JDLE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFBO0lBRTNDLElBQUksV0FBVyxJQUFJLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFBRTtRQUMxQyxPQUFPLE1BQU0sV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQTtLQUN2RTtJQUVELElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUU7UUFDekIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBTSxDQUFBO0tBQ3BDO0lBQ0QsT0FBUSxXQUE0QixDQUFBO0FBQ3RDLENBQUMsQ0FBQTtBQXhCVSxRQUFBLE1BQU0sVUF3QmhCO0FBRUgsTUFBTSxXQUFXLEdBQUcsS0FBSyxFQUN2QixFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxFQUNuQyxHQUFHLElBQVcsRUFDZCxFQUFFO0lBQ0YsTUFBTSxNQUFNLEdBQUcsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUN2QywyQ0FBMkM7SUFDM0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUN2QixVQUFVLENBQUMsQ0FBQztZQUNWLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzRCxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7S0FDOUM7SUFDRCxPQUFPLE1BQU0sQ0FBQTtBQUNmLENBQUMsQ0FBQSJ9